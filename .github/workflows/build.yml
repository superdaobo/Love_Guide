name: Build and Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Create web package
        run: |
          mkdir -p dist/web
          cp -r public/* dist/web/
          cp server.js dist/web/
          cp package.json dist/web/
          
      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/web/

  build-windows:
    runs-on: windows-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: dist/web/
      
      - name: Create Windows package
        run: |
          mkdir -p release/love-relationship-manager
          cp -r dist/web/* release/love-relationship-manager/
          cp package.json release/love-relationship-manager/
          Compress-Archive -Path release/love-relationship-manager -DestinationPath release/love-relationship-manager-windows.zip
        shell: pwsh
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: release/love-relationship-manager-windows.zip

  build-ios:
    runs-on: macos-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: public/
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli
      
      - name: Add iOS platform
        run: |
          npx cap init "Love Guide" com.love.guide --web-dir public || true
          npx cap add ios || true
          npx cap sync ios
      
      - name: Create iOS package
        run: |
          mkdir -p release
          if [ -d "ios/App" ]; then
            cd ios/App
            zip -r ../../release/love-relationship-manager-ios-xcode.zip .
          else
            echo "iOS App folder not found, creating placeholder"
            echo "iOS build requires manual setup" > release/ios-build-info.txt
          fi
        shell: bash
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: release/

  build-android:
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: public/
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli
      
      - name: Add Android platform
        run: |
          npx cap init "Love Guide" com.love.guide --web-dir public || true
          npx cap add android || true
          npx cap sync android
      
      - name: Build Android
        run: |
          cd android/app
          chmod +x gradlew
          ./gradlew assembleDebug
        continue-on-error: true
      
      - name: Create Android package
        run: |
          mkdir -p release
          if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            cp android/app/build/outputs/apk/debug/app-debug.apk release/love-relationship-manager-android.apk
          else
            cd android
            zip -r ../release/love-relationship-manager-android-project.zip .
          fi
      
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: release/

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: _site/
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site/

  github-pages:
    runs-on: ubuntu-latest
    needs: deploy-pages
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  create-release:
    runs-on: ubuntu-latest
    needs: [build-web, build-windows, build-ios, build-android]
    if: always() && (needs.build-web.result == 'success')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Get version
        id: version
        run: |
          VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: List artifacts
        run: ls -la artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Love Guide v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Love Guide v${{ steps.version.outputs.version }}
            
            ### ğŸ“± ä¸‹è½½
            - **Windows**: love-relationship-manager-windows.zip
            - **Android**: love-relationship-manager-android.apk æˆ– android-project.zip
            - **iOS**: love-relationship-manager-ios-xcode.zip (éœ€è¦è‡ªè¡Œç”¨Xcodeæ‰“å¼€ç¼–è¯‘)
            - **Web**: web-build.zip
            
            ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
            - ğŸ’ 400+ å¢è¿›æ„Ÿæƒ…æ–¹æ³•
            - ğŸ“ 100+ äº¤æµæ¡ˆä¾‹
            - âš ï¸ 100+ æ³¨æ„äº‹é¡¹
            - ğŸ¤– AI æ‹çˆ±é¡¾é—®
            - â° é‡è¦å€’æ•°æ—¥æé†’
            - ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
            2. è§£å‹åè¿è¡Œ `npm install && npm start`
            3. è®¿é—® http://localhost:3000
          files: |
            artifacts/windows-build/*
            artifacts/android-build/*
            artifacts/ios-build/*
            artifacts/web-build/*
          draft: false
          prerelease: false
