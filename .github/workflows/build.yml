name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version'
        required: false
        default: '1.0.0'

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Create web package
        run: |
          mkdir -p dist/web
          cp -r public/* dist/web/
          cp server.js dist/web/
          cp package.json dist/web/
          cp -r node_modules dist/web/ 2>/dev/null || true
          
      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/web/

  build-windows:
    runs-on: windows-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: dist/web/
      
      - name: Create Windows package
        run: |
          mkdir -p release
          Copy-Item -Recurse -Force dist/web release/love-relationship-manager
          Copy-Item database.sqlite release/love-relationship-manager/ 2>$null
          Compress-Archive -Path release/love-relationship-manager -DestinationPath release/love-relationship-manager-windows.zip
        shell: pwsh
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: release/love-relationship-manager-windows.zip

  build-ios:
    runs-on: macos-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: public/
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli
      
      - name: Add iOS platform
        run: |
          npx cap init "Love Guide" com.love.guide --web-dir public || true
          npx cap add ios || true
          npx cap sync ios
      
      - name: Build iOS (No Signing)
        run: |
          cd ios/App
          xcodebuild -workspace App.xcworkspace -scheme App -configuration Release -sdk iphoneos -destination 'generic/platform=iOS' CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO archive -archivePath build/App.xcarchive
          xcodebuild -exportArchive -archivePath build/App.xcarchive -exportOptionsPlist ExportOptions.plist -exportPath build/export || true
        continue-on-error: true
      
      - name: Create iOS package
        run: |
          mkdir -p release
          if [ -d "ios/App/build" ]; then
            cd ios/App/build
            zip -r ../../../release/love-relationship-manager-ios.zip .
          else
            cd ios/App
            zip -r ../../../release/love-relationship-manager-ios-xcode.zip .
          fi
        shell: bash
        continue-on-error: true
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: release/
        continue-on-error: true

  build-android:
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: public/
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli
      
      - name: Add Android platform
        run: |
          npx cap init "Love Guide" com.love.guide --web-dir public || true
          npx cap add android || true
          npx cap sync android
      
      - name: Build Android
        run: |
          cd android/app
          chmod +x gradlew
          ./gradlew assembleDebug
        continue-on-error: true
      
      - name: Create Android package
        run: |
          mkdir -p release
          if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            cp android/app/build/outputs/apk/debug/app-debug.apk release/love-relationship-manager-android.apk
          else
            cd android
            zip -r ../release/love-relationship-manager-android-project.zip .
          fi
        shell: bash
        continue-on-error: true
      
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: release/
        continue-on-error: true

  create-release:
    runs-on: ubuntu-latest
    needs: [build-web, build-windows, build-ios, build-android]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Get version
        id: version
        run: |
          VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Love Guide v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Love Guide v${{ steps.version.outputs.version }}
            
            ### ğŸ“± ä¸‹è½½
            - **Windows**: love-relationship-manager-windows.zip
            - **Android**: love-relationship-manager-android.apk
            - **iOS**: love-relationship-manager-ios.zip (éœ€è¦è‡ªè¡Œç­¾å)
            - **Web**: web-build.zip
            
            ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
            - ğŸ’ 400+ å¢è¿›æ„Ÿæƒ…æ–¹æ³•
            - ğŸ“ 100+ äº¤æµæ¡ˆä¾‹
            - âš ï¸ 100+ æ³¨æ„äº‹é¡¹
            - ğŸ¤– AI æ‹çˆ±é¡¾é—®
            - â° é‡è¦å€’æ•°æ—¥æé†’
            - ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
            2. è§£å‹åè¿è¡Œ server.js (éœ€è¦ Node.js)
            3. è®¿é—® http://localhost:3000
          files: |
            artifacts/windows-build/*
            artifacts/android-build/*
            artifacts/ios-build/*
            artifacts/web-build/*
          draft: false
          prerelease: false

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build-web
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: public/
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
