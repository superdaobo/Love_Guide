name: Build and Release

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Create web package
        run: |
          mkdir -p dist/web
          cp -r public/* dist/web/
          cp server.js dist/web/
          cp package.json dist/web/
          if [ -f "database.sqlite" ]; then
            cp database.sqlite dist/web/
          fi
          
      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/web/

  build-windows:
    runs-on: windows-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: dist/web/
      
      - name: Create Windows package
        run: |
          New-Item -ItemType Directory -Force -Path "release/love-relationship-manager"
          Copy-Item -Recurse -Force "dist/web/*" "release/love-relationship-manager/"
          Copy-Item -Force "package.json" "release/love-relationship-manager/"
          if (Test-Path "database.sqlite") {
            Copy-Item -Force "database.sqlite" "release/love-relationship-manager/"
          }
          Compress-Archive -Path "release/love-relationship-manager" -DestinationPath "release/love-relationship-manager-windows.zip"
        shell: pwsh
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: release/love-relationship-manager-windows.zip

  build-ios:
    runs-on: macos-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: public/
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli
      
      - name: Add iOS platform
        run: |
          npx cap init "Love Guide" com.love.guide --web-dir public || true
          npx cap add ios || true
          npx cap sync ios
      
      - name: Build iOS App (Unsigned)
        run: |
          cd ios/App
          xcodebuild -workspace App.xcworkspace -scheme App -configuration Debug -sdk iphoneos -arch arm64 CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY="" clean build
        continue-on-error: true
      
      - name: Create Unsigned IPA
        run: |
          mkdir -p release
          
          APP_PATH=$(find ios/App/build -name "App.app" -type d 2>/dev/null | head -1)
          
          if [ -n "$APP_PATH" ] && [ -d "$APP_PATH" ]; then
            echo "Found App.app at: $APP_PATH"
            mkdir -p release/Payload
            cp -r "$APP_PATH" release/Payload/
            if [ -f "database.sqlite" ]; then
              cp database.sqlite release/Payload/App.app/
            fi
            cd release
            zip -r love-relationship-manager-ios.ipa Payload
            rm -rf Payload
            echo "IPA created successfully"
          else
            echo "App.app not found, creating Xcode project zip instead"
            if [ -d "ios/App" ]; then
              cd ios/App
              zip -r ../../release/love-relationship-manager-ios-xcode.zip .
            fi
          fi
        shell: bash
      
      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: release/

  build-android:
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: public/
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli
      
      - name: Add Android platform
        run: |
          npx cap init "Love Guide" com.love.guide --web-dir public || true
          npx cap add android || true
          npx cap sync android
      
      - name: Build Android
        run: |
          cd android/app
          chmod +x gradlew
          ./gradlew assembleDebug
        continue-on-error: true
      
      - name: Create Android package
        run: |
          mkdir -p release
          if [ -f "android/app/build/outputs/apk/debug/app-debug.apk" ]; then
            cp android/app/build/outputs/apk/debug/app-debug.apk release/love-relationship-manager-android.apk
            if [ -f "database.sqlite" ]; then
              echo "Note: database.sqlite should be imported via app settings"
            fi
          else
            cd android
            zip -r ../release/love-relationship-manager-android-project.zip .
          fi
      
      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: release/

  deploy-pages:
    runs-on: ubuntu-latest
    needs: build-web
    steps:
      - uses: actions/checkout@v4
      
      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: _site/
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site/

  github-pages:
    runs-on: ubuntu-latest
    needs: deploy-pages
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  create-release:
    runs-on: ubuntu-latest
    needs: [build-web, build-windows, build-ios, build-android]
    if: always() && (needs.build-web.result == 'success')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Get version
        id: version
        run: |
          VERSION=$(cat package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: List artifacts
        run: ls -laR artifacts/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Love Guide v${{ steps.version.outputs.version }}
          body: |
            ## ğŸ‰ Love Guide v${{ steps.version.outputs.version }}
            
            ### ğŸ“± ä¸‹è½½
            - **Windows**: love-relationship-manager-windows.zip
            - **Android**: love-relationship-manager-android.apk
            - **iOS**: love-relationship-manager-ios.ipa (æœªç­¾åIPAï¼Œéœ€è¦è‡ªç­¾åå®‰è£…)
            - **Web**: web-build.zip
            
            ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
            - ğŸ’ 400+ å¢è¿›æ„Ÿæƒ…æ–¹æ³•
            - ğŸ“ 100+ äº¤æµæ¡ˆä¾‹
            - âš ï¸ 100+ æ³¨æ„äº‹é¡¹
            - ğŸ¤– AI æ‹çˆ±é¡¾é—®
            - â° é‡è¦å€’æ•°æ—¥æé†’
            - ğŸ“± ç§»åŠ¨ç«¯ä¼˜åŒ–
            - ğŸ’¾ å…¨å¹³å°æ•°æ®å¯¼å…¥/å¯¼å‡º
            
            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. Windows: è§£å‹åè¿è¡Œ `npm install && npm start`
            3. Android: ç›´æ¥å®‰è£… APK
            4. iOS: ä½¿ç”¨ AltStore æˆ–å…¶ä»–å·¥å…·è‡ªç­¾åå®‰è£… IPA
            5. è®¿é—® http://localhost:3000
            
            ### ğŸ“Š æ•°æ®è¿ç§»
            åœ¨è®¾ç½®é¡µé¢å¯ä»¥å¯¼å…¥/å¯¼å‡ºæ•°æ®ï¼Œæ”¯æŒå…¨å¹³å°é€šç”¨
          files: |
            artifacts/windows-build/*
            artifacts/android-build/*
            artifacts/ios-build/*
            artifacts/web-build/*
          draft: false
          prerelease: false
